<page-header></page-header>
<main role="main" class="app-main">
    <test-header [modify]="modify" (cancelChanges)="onCancelChanges()" (continueMakingChanges)="onContinueMakingChanges()" scheduleStep='Add details and review' [testSchedule]="testScheduleModel"></test-header>

    <div class="section">
        <div class="container-medium-width">
            <h4>You’re almost done!</h4>
            <form class="clearfix name-testing-session">
                <div class="one-half-grid">
                    <label class="label-bold label-larger" for="txtSessionName">Name your testing session</label>
                    <input type="text" id="txtSessionName" maxlength="75" autocomplete="off" #testsessionname (input)="onInput(testsessionname.value,ddlfaculty.value);">
                </div>
                <div class="one-half-grid lightbulb-icon-container">
                    <p class="icon lightbulb-icon">Your testing session contains all the details related to the test you are scheduling. Name it for easy
                        reference later.</p>
                </div>
                <div class="one-half-grid">
                    <label class="label-bold label-larger" for="ddlFaculty">Assign faculty member</label>
                    <select id="ddlFaculty" #ddlfaculty class="selectpicker" (change)="facultyChange(ddlfaculty.value,$event);" data-size="6" [disabled]="!facultyAssignable">
                        <option *ngFor="let admin of faculty" [value]="admin.AdminId" [selected]="admin.AdminId == testScheduleModel.facultyMemberId">{{admin.LastName}}, {{admin.FirstName}}</option>
                    </select>

                </div>
                <div *ngIf="facultyAssignable" class="one-half-grid lightbulb-icon-container" id="facultyLightbulbContainer">
                    <p class="icon lightbulb-icon">Both you and the faculty member you assign will be able to make changes to this testing session later
                        if needed.</p>
                </div>
            </form>
        </div>
    </div>




    <div class="container-medium-width">
        <h4>Review your testing session details</h4>

        <div class="margin-2em-bottom">
            <table class="review-details-table table-with-cell-padding justified-ends">
                <tr>
                    <th scope="row">Test</th>
                    <td>{{testScheduleModel.testName}}</td>
                    <td><a [routerLink]="modify ? ['/tests' , 'modify','choose-test',testScheduleModel.institutionId] : ['/tests/choose-test' , testScheduleModel.institutionId]">Change</a></td>
                </tr>
                <tr>
                    <th scope="row">Date and Time</th>
                    <td>
                        <template [ngIf]="!nextDay">
                            {{testScheduleModel?.scheduleStartTime|parseDate:'ddd'}} {{testScheduleModel?.scheduleStartTime|parseDate:'MM/DD/YY'}} from
                            {{testScheduleModel?.scheduleStartTime|parseDate:'h:mma'}} &ndash; {{testScheduleModel?.scheduleEndTime|parseDate:'h:mma'}}
                        </template>
                        <template [ngIf]="nextDay">
                            {{testScheduleModel?.scheduleStartTime|parseDate:'ddd'}} {{testScheduleModel?.scheduleStartTime|parseDate:'MM/DD/YY'}} from
                            {{testScheduleModel?.scheduleStartTime|parseDate:'h:mma'}} &ndash; {{testScheduleModel?.scheduleEndTime|parseDate:'h:mma'}}
                            {{testScheduleModel?.scheduleEndTime|parseDate:'ddd'}} {{testScheduleModel?.scheduleEndTime|parseDate:'MM/DD/YY'}}
                        </template>

                    </td>
                    <td><a href="#" target="_self" [routerLink]="modify ? ['/tests','modify','schedule-test'] : ['/tests/schedule-test']">Change</a>
                    </td>
                </tr>
                
                </tbody>
            </table>
        </div>
        <h4 class="teal" id="studentsInTestingSessionConfirmation">Students in Testing Session ({{unmarkedStudentsCount()}})</h4>
        <a [routerLink]="modify ? ['/tests','modify','add-students'] : ['/tests','add-students']">Change</a>
        <button class="right anchor-button" *ngIf="(retesterExceptions?.length>0 && hasAlternateTests) || (retesterExceptions?.length>0 && hasSavedRetesterExceptions) || (modify && retesterExceptionsModify?.length>0)" (click)="changeAlternateAssignments($event)">Change alternate test assignments</button>

        <table id="studentsInTestingSessionTable" class="dataTable-bordered table-with-cell-padding table-striped last-row-no-border">
            <thead>
                <tr>
                    <th scope="col">Last Name</th>
                    <th scope="col">First Name</th>
                    <th scope="col">Cohort</th>
                    <th scope="col">Test</th>
                    <th scope="col">Norming Status</th>
                </tr>
            </thead>
            <tbody>
                <!--<template ngFor #student [ngForOf]="testScheduleModel.selectedStudents">
                    <tr *ngIf="resolveMarked(student)">
                        <tr>
                </template>-->
                <tr *ngFor="let student of testScheduleModel.selectedStudents;  let _student=student" [hidden]="resolveMarked(student)">
                    <td [class.name-with-pay-alert]="student.StudentPay">{{student.LastName}} 
                        <img *ngIf="student.StudentPay" src="assets/images/self-pay-alert-icon.svg" class="self-pay-alert-table-icon" alt="payment alert icon"/>
                    </td>
                    <td>{{student.FirstName}}</td>
                    <td>{{student.CohortName}}</td>
                    <td>{{student.StudentTestName}}</td>
                    <td>{{student.NormingStatus ? student.NormingStatus : testScheduleModel.testNormingStatus}}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="container-medium-width section section-top-thin">
        <div class="icon-container-flush-text clearfix">
            <p class="icon info-icon-yellow margin-1em-top" *ngIf="hasADA">One or more of the students you have added have testing accommodations. Their test will be untimed. For more information or to designate additional students who need testing accommodations, please contact your Account Manager.</p>
            <p class="icon info-icon-yellow margin-1em-top" *ngIf="!hasADA">Please contact your Account Manager if there are students in your testing session who need testing accommodations. Students with testing accommodations receive untimed versions of their tests.</p>
            <img *ngIf="hasStudentPay" src="assets/images/self-pay-alert-icon.svg" class="self-pay-alert-icon" alt="payment alert icon" height="22" width="22"/>
            <p *ngIf="hasStudentPay">
                 These students have been deactivated due to non-payment. They will not be able to access their test during the specified testing window unless their balance is paid in full at least two business days prior to test day.
             </p>

            
            <!--<a href="confirmation.html" id="chooseDate" class="button right margin-2em-top button-mobile-block" aria-disabled="true" disabled>Confirm info and schedule test</a>-->
            <button type="submit" (click)="scheduleTest($event);" id="btnScheduleTest" class="button right margin-2em-top-bottom button-mobile-block"
            [disabled]="!valid">
                Confirm info and schedule test
            </button>
        </div>
    </div>

</main>

<page-footer></page-footer>
<confirmation-popup [popupId]="'confirmationPopup'" [message]="'Are you sure you want to leave this page? <br>Your work will be lost and you’ll have to start over.'"
[okButtonText]="'Yes, leave this page'" [cancelButtonText]="'No, stay on this page'" (onOK)="onOKConfirmation()" (onCancel)="onCancelConfirmation($event)"
[hideClose]="false">
</confirmation-popup>
<loader [loaderMessage]="'Scheduling your testing session…'" [greetingMessage]="'Thank you for your patience!'"></loader>

<alert-popup 
    [popupId]="'alertPopup'"
    [message]="'We’re sorry! The testing window you specified has expired and needs to be changed. Please specify a new testing window.'" 
    [okButtonText] = "'OK'"     
    (onOK)="onOKAlert()"    
    [hideClose]="false">
</alert-popup>

<alert-popup [popupId]="'testPassed'"
             [message]="'We’re sorry! You can no longer modify this testing session because it has already taken place. Click or tap “OK” to go back to the Manage Tests main page.'"
             [okButtonText]="'OK'"
             (onOK)="cancelStartingTestChanges($event)"
             [hideClose]="false">
</alert-popup>

<alert-popup [popupId]="'testStarted'"
             [message]="'We’re sorry! This testing session is now underway and you can no longer modify it from this location. Click or tap “OK” to go to the Manage Tests main page, where you will be able to make changes to this testing session.'"
             [okButtonText]="'OK'"
             (onOK)="cancelStartingTestChanges($event)"
             [hideClose]="false">
</alert-popup>

<test-starting-popup [popupId]="'testStartingin5'"
                    [heading]="'Alert: Testing Session Starting in 5 Minutes'"
                    leadParagraph="This testing session is scheduled to start in <b>5 minutes ({{testScheduleModel.scheduleStartTime|parseDate:'h:mma'}})</b>."
                    [paragraph]="'Once this testing session is in progress, you will no longer be able to modify it from this location.'"
                    [okButtonText]="'Continue modifying this session'"
                    [cancelButtonText]="'Cancel changes'"
                    (onOK)="onCancelConfirmation($event)"
                    (onCancel)="cancelStartingTestChanges($event)">
</test-starting-popup>

<test-starting-popup [popupId]="'testStartingin10'"
                    [heading]="'Alert: Testing Session Starting in 10 Minutes'"
                    leadParagraph="This testing session is scheduled to start in <b>10 minutes ({{testScheduleModel.scheduleStartTime|parseDate:'h:mma'}})</b>."
                    [paragraph]="'Once this testing session is in progress, you will no longer be able to modify it from this location.'"
                    [okButtonText]="'Continue modifying this session'"
                    [cancelButtonText]="'Cancel changes'"
                    (onOK)="onCancelConfirmation($event)"
                    (onCancel)="cancelStartingTestChanges($event)">
</test-starting-popup>

<retesters-noalternate
[testSchedule]="testScheduleModel"
[studentRepeaters]="popupStudentRepeaterExceptions"
(retesterNoAlternatePopupOK) = "onRetesterNoAlternatePopupOK($event)"
(retesterNoAlternatePopupCancel) = "onRetesterNoAlternatePopupCancel($event)">
</retesters-noalternate>

<retesters-alternate
[retesterExceptions]="popupRetesterExceptions"
[testTakenStudents]="popupTestTakenStudents"
[testScheduledSudents]="popupTestScheduledSudents"
[testSchedule]="testScheduleModel"
(retesterAlternatePopupOK)="onRetesterAlternatePopupOK($event)"
(retesterAlternatePopupCancel)="onRetesterAlternatePopupCancel($event)">
</retesters-alternate>



<time-exception
[studentWindowException]="popupStudentWindowException"
canRemoveStudents="true"
[testSchedule]="testScheduleModel"
(windowExceptionPopupClose)="onWindowExceptionPopupClose($event)">    
</time-exception>